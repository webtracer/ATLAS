@page "/servers"
@using System.Net.Http.Json
@using Amdocs.Atlas.Core.Entities
@using Environment = Amdocs.Atlas.Core.Entities.Environment
@inject IHttpClientFactory HttpClientFactory

<h3>Servers</h3>

<p><strong>Debug:</strong> isCreating = @isCreating, isEditing = @isEditing</p>

@if (isLoading)
{
    <p>Loading servers...</p>
}
else if (!string.IsNullOrEmpty(loadError))
{
    <div class="alert alert-danger">
        Error loading servers: @loadError
    </div>
}
else
{
    <button type="button"
            class="btn btn-primary mb-3"
            @onclick="StartCreate">
        Add Server
    </button>

    @if (servers.Count == 0)
    {
        <p>No servers found.</p>
    }
    else
    {
        <table class="table table-striped">
            <thead>
            <tr>
                <th>Hostname</th>
                <th>IP Address</th>
                <th>VCenter IP</th>
                <th>Customer</th>
                <th>Environment</th>
                <th>Role</th>
                <th>Operating System</th>
                <th style="width: 150px;"></th>
            </tr>
            </thead>
            <tbody>
            @foreach (var server in servers)
            {
                <tr>
                    <td>@server.Hostname</td>
                    <td>@server.IpAddress</td>
                    <td>@GetVcenterIp(server.VcenterId)</td>
                    <td>@GetCustomerName(server.CustomerId)</td>
                    <td>@GetEnvironmentName(server.EnvironmentId)</td>
                    <td>@GetRoleName(server.RoleId)</td>
                    <td>@server.OsName</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-2" @onclick="() => StartEdit(server)">Edit</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => ConfirmDelete(server)">Delete</button>
                    </td>
                </tr>
            }
            </tbody>
        </table>

    }

    @if (isCreating || isEditing)
    {
        <div class="card mt-4">
            <div class="card-header">
                @(isCreating ? "Add Server" : "Edit Server")
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Hostname</label>
                    <InputText class="form-control" @bind-Value="editModel.Hostname" />
                </div>

                <div class="mb-3">
                    <label class="form-label">IP Address</label>
                    <InputText class="form-control" @bind-Value="editModel.IpAddress" />
                </div>
                
                <div class="mb-3">
                    <label class="form-label">VCenter (IP)</label>
                    <select class="form-select" @bind="editModel.VcenterId">
                        <option value="">-- Select VCenter --</option>
                        @foreach (var vcenter in vcenters)
                        {
                            <option value="@vcenter.VcenterId">
                                @vcenter.IpAddress @if (!string.IsNullOrWhiteSpace(vcenter.Name)) { @($" ({vcenter.Name})") }
                            </option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Customer</label>
                    <select class="form-select" @bind="editModel.CustomerId">
                        <option value="">-- Select Customer --</option>
                        @foreach (var customer in customers)
                        {
                            <option value="@customer.CustomerId">@customer.Name</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Environment</label>
                    <select class="form-select" @bind="editModel.EnvironmentId">
                        <option value="">-- Select Environment --</option>
                        @foreach (var env in environments)
                        {
                            <option value="@env.EnvironmentId">@env.Name</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Role</label>
                    <select class="form-select" @bind="editModel.RoleId">
                        <option value="0">-- Select Role --</option>
                        @foreach (var role in roles)
                        {
                            <option value="@role.RoleId">@role.Name</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Operating System</label>
                    <InputText class="form-control" @bind-Value="editModel.OsName" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Operating System Version</label>
                    <InputText class="form-control" @bind-Value="editModel.OsFamily" />
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input"
                           type="checkbox"
                           id="isActiveCheck"
                           @bind="editModel.IsActive" />
                    <label class="form-check-label" for="isActiveCheck">
                        Active
                    </label>
                </div>

                <button type="button"
                        class="btn btn-primary me-2"
                        @onclick="SaveAsync">
                    Save
                </button>
                <button type="button"
                        class="btn btn-secondary"
                        @onclick="CancelEdit">
                    Cancel
                </button>
            </div>
        </div>
    }

    @if (deleteCandidate is not null)
    {
        <div class="alert alert-warning mt-4">
            <p>
                Are you sure you want to delete server
                <strong>@deleteCandidate.Hostname</strong> (Id: @deleteCandidate.ServerId)?
            </p>
            <button type="button"
                    class="btn btn-danger me-2"
                    @onclick="ConfirmDeleteAsync">
                Yes, delete
            </button>
            <button type="button"
                    class="btn btn-secondary"
                    @onclick="CancelDelete">
                Cancel
            </button>
        </div>
    }
}

@code {
    private List<Server> servers = new();
    private List<Vcenter> vcenters = new();
    private bool isLoading = true;
    private string? loadError;

    private bool isCreating;
    private bool isEditing;
    private Server editModel = new();

    private Server? deleteCandidate;
    
    private List<Environment> environments = new();
    private List<Role> roles = new();
    private List<Customer> customers = new();

    private string GetEnvironmentName(int environmentId) =>
        environments.FirstOrDefault(e => e.EnvironmentId == environmentId)?.Name
        ?? environmentId.ToString();

    private string GetRoleName(int roleId) =>
        roles.FirstOrDefault(r => r.RoleId == roleId)?.Name
        ?? roleId.ToString();

    private string GetCustomerName(int? customerId) =>
        customerId is null
            ? string.Empty
            : customers.FirstOrDefault(c => c.CustomerId == customerId)?.Name
              ?? customerId.Value.ToString();

    private string GetVcenterIp(int? vcenterId)
        => vcenterId is int id
            ? vcenters.FirstOrDefault(v => v.VcenterId == id)?.IpAddress ?? string.Empty
            : string.Empty;

    /*protected override async Task OnInitializedAsync()
    {
        await LoadServersAsync();
    }*/
    
    protected override async Task OnInitializedAsync()
    {
        await LoadLookupsAsync();
        await LoadServersAsync();
    }

    private async Task LoadLookupsAsync()
    {
        try
        {
            var client = CreateClient();

            var envResult = await client.GetFromJsonAsync<List<Environment>>("api/environments");
            environments = envResult ?? new List<Environment>();

            var roleResult = await client.GetFromJsonAsync<List<Role>>("api/roles");
            roles = roleResult ?? new List<Role>();

            var customerResult = await client.GetFromJsonAsync<List<Customer>>("api/customers");
            customers = customerResult ?? new List<Customer>();
            
            var vcenterResult = await client.GetFromJsonAsync<List<Vcenter>>("api/vcenters");
            vcenters = vcenterResult ?? new List<Vcenter>();

        }
        catch (Exception ex)
        {
            // Donâ€™t block the whole page, but log the error
            loadError = $"Failed to load lookups: {ex.Message}";
        }
    }
    
    private HttpClient CreateClient() => HttpClientFactory.CreateClient("AtlasApi");

    private async Task LoadServersAsync()
    {
        isLoading = true;
        loadError = null;

        try
        {
            var client = CreateClient();
            var result = await client.GetFromJsonAsync<List<Server>>("api/servers");
            servers = result ?? new List<Server>();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void StartCreate()
    {
        isCreating = true;
        isEditing = false;
        deleteCandidate = null;

        editModel = new Server
        {
            IsActive = true,
            IsVm = true,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };

        StateHasChanged();
    }
    
    // /*
    // -------------------------
    // DELETE HANDLER
    // -------------------------
    private void ConfirmDelete(Server server)
    {
        deleteCandidate = server;
        ShowDeleteConfirm = true;
    }

    private bool ShowDeleteConfirm = false;

    // Call this from your "Yes, delete" button
    private async Task DeleteServerAsync()
    {
        if (deleteCandidate is null)
        {
            ShowDeleteConfirm = false;
            return;
        }

        try
        {
            var client = CreateClient();

            var response = await client.DeleteAsync($"api/servers/{deleteCandidate.ServerId}");
            response.EnsureSuccessStatusCode();

            await LoadServersAsync();
        }
        catch (Exception ex)
        {
            loadError = $"Failed to delete server: {ex.Message}";
        }
        finally
        {
            ShowDeleteConfirm = false;
            deleteCandidate = null;
        }
    }
//*/

    private void StartEdit(Server server)
    {
        isEditing = true;
        isCreating = false;
        deleteCandidate = null;

        editModel = new Server
        {
            ServerId          = server.ServerId,
            Hostname          = server.Hostname,
            Fqdn              = server.Fqdn,
            IpAddress         = server.IpAddress,
            SecondaryIp       = server.SecondaryIp,
            OsName            = server.OsName,
            OsFamily          = server.OsFamily,
            OsMajorVersion    = server.OsMajorVersion,
            IsVm              = server.IsVm,
            SourceType        = server.SourceType,
            VmInstanceUuid    = server.VmInstanceUuid,
            VmBiosUuid        = server.VmBiosUuid,
            IsActive          = server.IsActive,
            LifecycleStatus   = server.LifecycleStatus,
            CreatedAt         = server.CreatedAt,
            UpdatedAt         = server.UpdatedAt,
            CommissionedAt    = server.CommissionedAt,
            DecommissionedAt  = server.DecommissionedAt,
            EnvironmentId     = server.EnvironmentId,
            RoleId            = server.RoleId,
            OwnerId           = server.OwnerId,
            LocationId        = server.LocationId,
            CustomerId        = server.CustomerId,
            VcenterId         = server.VcenterId,
            ProjectId         = server.ProjectId
        };
    }
    
    private async Task SaveAsync()
    {
        try
        {
            // basic guard so we don't send junk
            if (editModel.RoleId == 0)
            {
                loadError = "Please select a role before saving.";
                return;
            }
            
            var client = CreateClient();
            HttpResponseMessage response;

            if (isCreating)
            {
                response = await client.PostAsJsonAsync("api/servers", editModel);
            }
            else if (isEditing)
            {
                response = await client.PutAsJsonAsync($"api/servers/{editModel.ServerId}", editModel);
            }
            else
            {
                return;
            }

            if (!response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                loadError = $"Save failed ({(int)response.StatusCode} {response.StatusCode}): {content}";
                return;
            }

            isCreating = false;
            isEditing = false;
            editModel = new Server();

            await LoadServersAsync();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private void CancelEdit()
    {
        isCreating = false;
        isEditing = false;
        editModel = new Server();
    }

    private async Task ConfirmDeleteAsync()
    {
        if (deleteCandidate is null)
            return;

        try
        {
            var client = CreateClient();
            var response = await client.DeleteAsync($"api/servers/{deleteCandidate.ServerId}");
            response.EnsureSuccessStatusCode();

            deleteCandidate = null;
            await LoadServersAsync();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private void CancelDelete()
    {
        deleteCandidate = null;
    }
}
