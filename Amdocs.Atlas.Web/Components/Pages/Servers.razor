@page "/servers"
@using System.Net.Http.Json
@using Amdocs.Atlas.Core.Entities
@using Amdocs.Atlas.Core.DTOs
@using Environment = Amdocs.Atlas.Core.Entities.Environment
@using System.Linq
@inject IHttpClientFactory HttpClientFactory
@using Microsoft.AspNetCore.Components.Forms;

<h3>Servers</h3>

@if (isLoading)
{
    <p>Loading servers...</p>
}
else if (!string.IsNullOrEmpty(loadError))
{
    <div class="alert alert-danger">
        Error loading servers: @loadError
    </div>
}
else
{
    <button type="button"
            class="btn btn-primary mb-3"
            @onclick="StartCreate">
        Add Server
    </button>
    
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Bulk Import Servers from Excel</h5>
            <p class="card-text">
                Upload an <code>.xlsx</code> file with the expected columns
                (Hostname, IpAddress, Customer, Environment, Role, Vcenter, Fqdn, Os, Location, Notes).
            </p>

            <div class="row g-2 align-items-center">
                <div class="col-md-4">
                    <InputFile OnChange="OnFileSelected" />
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary"
                            @onclick="ImportServersAsync"
                            disabled="@(! (importFile is not null) || isImporting)">
                        @(isImporting ? "Importing..." : "Import Servers")
                    </button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(importMessage))
            {
                <div class="mt-3">
                    <strong>@importMessage</strong>
                </div>
            }

            @if (importErrors.Count > 0)
            {
                <div class="mt-3">
                    <h6>Row Errors</h6>
                    <table class="table table-sm table-bordered">
                        <thead>
                        <tr>
                            <th>Row</th>
                            <th>Error</th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var err in importErrors)
                        {
                            <tr>
                                <td>@err.RowNumber</td>
                                <td>@err.Message</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <!-- Filters + Search -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Search (Hostname or IP)</label>
                    <input class="form-control"
                           type="text"
                           value="@searchText"
                           @oninput="OnSearchChanged"
                           placeholder="e.g. qat24 or 10.10.10.10" />

                </div>

                <div class="col-md-3">
                    <label class="form-label">Customer</label>
                    <select class="form-select"
                            value="@selectedCustomerId"
                            @onchange="OnCustomerFilterChanged">
                        <option value="0">All Customers</option>
                        @foreach (var customer in customers)
                        {
                            <option value="@customer.CustomerId">@customer.Name</option>
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Environment</label>
                    <select class="form-select"
                            value="@selectedEnvironmentId"
                            @onchange="OnEnvironmentFilterChanged">
                        <option value="0">All Environments</option>
                        @foreach (var env in environments)
                        {
                            <option value="@env.EnvironmentId">@env.Name</option>
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">VCenter</label>
                    <select class="form-select"
                            value="@selectedVcenterId"
                            @onchange="OnVcenterFilterChanged">
                        <option value="0">All VCenters</option>
                        @foreach (var vcenter in vcenters)
                        {
                            <option value="@vcenter.VcenterId">
                                @vcenter.IpAddress @if (!string.IsNullOrWhiteSpace(vcenter.Name)) { @($" ({vcenter.Name})") }
                            </option>
                        }
                    </select>
                </div>
            </div>
        </div>
    </div>

    @if (servers.Count == 0)
    {
        <p>No servers found.</p>
    }
    else
    {
        <table class="table table-striped">
            <thead>
            <tr>
                <th style="width: 80px;">RDP</th>
                <th>Hostname</th>
                <th>IP Address</th>
                <th>VCenter IP</th>
                <th>Customer</th>
                <th>Environment</th>
                <th>Role</th>
                <th>Operating System</th>
                <th style="width: 150px;"></th>
            </tr>
            </thead>

            <tbody>
            @foreach (var server in servers)
            {
                <tr>
                    <td>
                        @if (!string.IsNullOrWhiteSpace(server.IpAddress))
                        {
                            <a class="btn btn-sm btn-outline-primary"
                               href="@BuildRdpUrl(server)">
                                RDP
                            </a>
                        }
                    </td>
                    <td>@server.Hostname</td>
                    <td>@server.IpAddress</td>
                    <td>@GetVcenterIp(server.VcenterId)</td>
                    <td>@GetCustomerName(server.CustomerId)</td>
                    <td>@GetEnvironmentName(server.EnvironmentId)</td>
                    <td>@GetRoleName(server.RoleId)</td>
                    <td>@server.OsName</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-2" @onclick="() => StartEdit(server)">Edit</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => ConfirmDelete(server)">Delete</button>
                    </td>
                </tr>
            }
            </tbody>

        </table>
    }

    @if (isCreating || isEditing)
    {
        <div class="card mt-4">
            <div class="card-header">
                @(isCreating ? "Add Server" : "Edit Server")
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Hostname</label>
                    <InputText class="form-control" @bind-Value="editModel.Hostname" />
                </div>

                <div class="mb-3">
                    <label class="form-label">IP Address</label>
                    <InputText class="form-control" @bind-Value="editModel.IpAddress" />
                </div>
                
                <div class="mb-3">
                    <label class="form-label">VCenter (IP)</label>
                    <select class="form-select" @bind="editModel.VcenterId">
                        <option value="">-- Select VCenter --</option>
                        @foreach (var vcenter in vcenters)
                        {
                            <option value="@vcenter.VcenterId">
                                @vcenter.IpAddress @if (!string.IsNullOrWhiteSpace(vcenter.Name)) { @($" ({vcenter.Name})") }
                            </option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Customer</label>
                    <select class="form-select" @bind="editModel.CustomerId">
                        <option value="">-- Select Customer --</option>
                        @foreach (var customer in customers)
                        {
                            <option value="@customer.CustomerId">@customer.Name</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Environment</label>
                    <select class="form-select" @bind="editModel.EnvironmentId">
                        <option value="">-- Select Environment --</option>
                        @foreach (var env in environments)
                        {
                            <option value="@env.EnvironmentId">@env.Name</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Role</label>
                    <select class="form-select" @bind="editModel.RoleId">
                        <option value="">-- Select Role --</option>
                        @foreach (var role in roles)
                        {
                            <option value="@role.Id">@role.Name</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Operating System</label>
                    <InputText class="form-control" @bind-Value="editModel.OsName" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Operating System Version</label>
                    <InputText class="form-control" @bind-Value="editModel.OsFamily" />
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input"
                           type="checkbox"
                           id="isActiveCheck"
                           @bind="editModel.IsActive" />
                    <label class="form-check-label" for="isActiveCheck">
                        Active
                    </label>
                </div>

                <button type="button"
                        class="btn btn-primary me-2"
                        @onclick="SaveAsync">
                    Save
                </button>
                <button type="button"
                        class="btn btn-secondary"
                        @onclick="CancelEdit">
                    Cancel
                </button>
            </div>
        </div>
    }

    @if (deleteCandidate is not null)
    {
        <div class="alert alert-warning mt-4">
            <p>
                Are you sure you want to delete server
                <strong>@deleteCandidate.Hostname</strong> (Id: @deleteCandidate.ServerId)?
            </p>
            <button type="button"
                    class="btn btn-danger me-2"
                    @onclick="ConfirmDeleteAsync">
                Yes, delete
            </button>
            <button type="button"
                    class="btn btn-secondary"
                    @onclick="CancelDelete">
                Cancel
            </button>
        </div>
    }
}

@code {
    // master data + filtered view
    private List<Server> allServers = new();
    private List<Server> servers = new();

    private List<Vcenter> vcenters = new();
    private List<Environment> environments = new();
    private List<RoleDto> roles = new();
    private List<Customer> customers = new();

    private bool isLoading = true;
    private string? loadError;

    private bool isCreating;
    private bool isEditing;
    private Server editModel = new();

    private Server? deleteCandidate;

    // filter/search state (simple fields)
    private string? searchText;
    private int selectedCustomerId;
    private int selectedEnvironmentId;
    private int selectedVcenterId;
    
    private string apiBaseUrl = string.Empty;

    private IBrowserFile? importFile;
    private bool isImporting;
    private string? importMessage;

    private string GetEnvironmentName(int environmentId) =>
        environments.FirstOrDefault(e => e.EnvironmentId == environmentId)?.Name
        ?? environmentId.ToString();

    private string GetRoleName(int roleId) =>
        roles.FirstOrDefault(r => r.Id == roleId)?.Name
        ?? roleId.ToString();

    private string GetCustomerName(int? customerId) =>
        customerId is null
            ? string.Empty
            : customers.FirstOrDefault(c => c.CustomerId == customerId)?.Name
              ?? customerId.Value.ToString();

    private string GetVcenterIp(int? vcenterId)
        => vcenterId is int id
            ? vcenters.FirstOrDefault(v => v.VcenterId == id)?.IpAddress ?? string.Empty
            : string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var client = CreateClient();
        apiBaseUrl = client.BaseAddress?.ToString().TrimEnd('/') ?? string.Empty;

        await LoadLookupsAsync();
        await LoadServersAsync();
    }


    private async Task LoadLookupsAsync()
    {
        try
        {
            var client = CreateClient();

            var envResult = await client.GetFromJsonAsync<List<Environment>>("api/environments");
            environments = envResult ?? new List<Environment>();

            var roleResult = await client.GetFromJsonAsync<List<RoleDto>>("api/roles");
            roles = roleResult ?? new List<RoleDto>();


            var customerResult = await client.GetFromJsonAsync<List<Customer>>("api/customers");
            customers = customerResult ?? new List<Customer>();
            
            var vcenterResult = await client.GetFromJsonAsync<List<Vcenter>>("api/vcenters");
            vcenters = vcenterResult ?? new List<Vcenter>();
        }
        catch (Exception ex)
        {
            loadError = $"Failed to load lookups: {ex.Message}";
        }
    }
    
    private HttpClient CreateClient() => HttpClientFactory.CreateClient("AtlasApi");

    private async Task LoadServersAsync()
    {
        isLoading = true;
        loadError = null;

        try
        {
            var client = CreateClient();
            var result = await client.GetFromJsonAsync<List<Server>>("api/servers");
            allServers = result ?? new List<Server>();

            ApplyFilters();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
            servers = new List<Server>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void StartCreate()
    {
        isCreating = true;
        isEditing = false;
        deleteCandidate = null;

        editModel = new Server
        {
            IsActive = true,
            IsVm = true,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };
    }

    private void StartEdit(Server server)
    {
        isEditing = true;
        isCreating = false;
        deleteCandidate = null;

        editModel = new Server
        {
            ServerId          = server.ServerId,
            Hostname          = server.Hostname,
            Fqdn              = server.Fqdn,
            IpAddress         = server.IpAddress,
            SecondaryIp       = server.SecondaryIp,
            OsName            = server.OsName,
            OsFamily          = server.OsFamily,
            OsMajorVersion    = server.OsMajorVersion,
            IsVm              = server.IsVm,
            SourceType        = server.SourceType,
            VmInstanceUuid    = server.VmInstanceUuid,
            VmBiosUuid        = server.VmBiosUuid,
            IsActive          = server.IsActive,
            LifecycleStatus   = server.LifecycleStatus,
            CreatedAt         = server.CreatedAt,
            UpdatedAt         = server.UpdatedAt,
            CommissionedAt    = server.CommissionedAt,
            DecommissionedAt  = server.DecommissionedAt,
            EnvironmentId     = server.EnvironmentId,
            RoleId            = server.RoleId,
            OwnerId           = server.OwnerId,
            LocationId        = server.LocationId,
            CustomerId        = server.CustomerId,
            VcenterId         = server.VcenterId,
            ProjectId         = server.ProjectId
        };
    }
    
    private async Task SaveAsync()
    {
        try
        {
            if (editModel.RoleId == 0)
            {
                loadError = "Please select a role before saving.";
                return;
            }
            
            var client = CreateClient();
            HttpResponseMessage response;

            if (isCreating)
            {
                response = await client.PostAsJsonAsync("api/servers", editModel);
            }
            else if (isEditing)
            {
                response = await client.PutAsJsonAsync($"api/servers/{editModel.ServerId}", editModel);
            }
            else
            {
                return;
            }

            if (!response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                loadError = $"Save failed ({(int)response.StatusCode} {response.StatusCode}): {content}";
                return;
            }

            isCreating = false;
            isEditing = false;
            editModel = new Server();

            await LoadServersAsync();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private void CancelEdit()
    {
        isCreating = false;
        isEditing = false;
        editModel = new Server();
    }

    private void ConfirmDelete(Server server)
    {
        deleteCandidate = server;
        isCreating = false;
        isEditing = false;
    }

    private async Task ConfirmDeleteAsync()
    {
        if (deleteCandidate is null)
            return;

        try
        {
            var client = CreateClient();
            var response = await client.DeleteAsync($"api/servers/{deleteCandidate.ServerId}");
            response.EnsureSuccessStatusCode();

            deleteCandidate = null;
            await LoadServersAsync();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private void CancelDelete()
    {
        deleteCandidate = null;
    }
    
    private string BuildRdpUrl(Server server)
    {
        if (string.IsNullOrWhiteSpace(server.IpAddress))
            return "#";

        if (string.IsNullOrEmpty(apiBaseUrl))
            return $"api/rdp/server/{server.ServerId}";

        return $"{apiBaseUrl}/api/rdp/server/{server.ServerId}";
    }


    // -------- Filter & search handlers --------

    private void OnSearchChanged(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString();
        ApplyFilters();
    }

    private void OnCustomerFilterChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var value))
            selectedCustomerId = value;
        else
            selectedCustomerId = 0;

        ApplyFilters();
    }

    private void OnEnvironmentFilterChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var value))
            selectedEnvironmentId = value;
        else
            selectedEnvironmentId = 0;

        ApplyFilters();
    }

    private void OnVcenterFilterChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var value))
            selectedVcenterId = value;
        else
            selectedVcenterId = 0;

        ApplyFilters();
    }

    private void ApplyFilters()
    {
        IEnumerable<Server> query = allServers;

        if (selectedCustomerId != 0)
        {
            query = query.Where(s => s.CustomerId == selectedCustomerId);
        }

        if (selectedEnvironmentId != 0)
        {
            query = query.Where(s => s.EnvironmentId == selectedEnvironmentId);
        }

        if (selectedVcenterId != 0)
        {
            query = query.Where(s => s.VcenterId == selectedVcenterId);
        }

        if (!string.IsNullOrWhiteSpace(searchText))
        {
            var term = searchText.Trim();
            query = query.Where(s =>
                (!string.IsNullOrEmpty(s.Hostname) &&
                 s.Hostname.Contains(term, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(s.IpAddress) &&
                 s.IpAddress.Contains(term, StringComparison.OrdinalIgnoreCase)));
        }

        servers = query.ToList();
    }
    
    private async Task ImportServersAsync()
{
    if (importFile is null)
    {
        importMessage = "Please select an Excel file first.";
        return;
    }

    isImporting = true;
    importMessage = null;
    importErrors.Clear();

    try
    {
        var client = CreateClient();

        using var content = new MultipartFormDataContent();
        var stream = importFile.OpenReadStream(long.MaxValue); // or some sane limit like 10MB

        var fileContent = new StreamContent(stream);
        fileContent.Headers.ContentType =
            new System.Net.Http.Headers.MediaTypeHeaderValue(importFile.ContentType ?? "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

        content.Add(fileContent, "file", importFile.Name);

        var response = await client.PostAsync("api/servers/import", content);

        if (!response.IsSuccessStatusCode)
        {
            var errorText = await response.Content.ReadAsStringAsync();
            importMessage = $"Import failed ({(int)response.StatusCode} {response.StatusCode}): {errorText}";
            return;
        }

        var result = await response.Content.ReadFromJsonAsync<ServerImportResultView>();

        if (result is null)
        {
            importMessage = "Import completed, but no result was returned.";
            return;
        }

        importMessage = $"Import completed. Imported {result.ImportedCount} of {result.TotalRows} rows. " +
                        $"Failed rows: {result.FailedCount}.";

        if (result.Errors != null)
        {
            importErrors = result.Errors
                .Select(e => new ImportError
                {
                    RowNumber = e.RowNumber,
                    Message = e.Message
                })
                .ToList();
        }

        // Refresh the grid
        await LoadServersAsync();
    }
    catch (Exception ex)
    {
        importMessage = $"Unexpected error during import: {ex.Message}";
    }
    finally
    {
        isImporting = false;
    }
}

// Local view model to match the API result
private class ServerImportResultView
{
    public int TotalRows { get; set; }
    public int ImportedCount { get; set; }
    public int FailedCount { get; set; }
    public List<ServerImportRowErrorView> Errors { get; set; } = new();
}

private class ServerImportRowErrorView
{
    public int RowNumber { get; set; }
    public string Message { get; set; } = string.Empty;
}

    
    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        importErrors.Clear();
        importMessage = null;

        if (e.FileCount == 0)
        {
            importFile = null;
            return;
        }

        var file = e.File;
        // Optional: validate extension
        if (!file.Name.EndsWith(".xlsx", StringComparison.OrdinalIgnoreCase))
        {
            importMessage = "Please upload an .xlsx Excel file.";
            importFile = null;
            return;
        }

        importFile = file;
    }

    
    private class ImportError
    {
        public int RowNumber { get; set; }
        public string Message { get; set; } = string.Empty;
    }

    private List<ImportError> importErrors = new();
}





@*  Pre-search implementation Servers.razor
@page "/servers"
@using System.Net.Http.Json
@using Amdocs.Atlas.Core.Entities
@using Environment = Amdocs.Atlas.Core.Entities.Environment
@inject IHttpClientFactory HttpClientFactory

<h3>Servers</h3>

$1$<p><strong>Debug:</strong> isCreating = @isCreating, isEditing = @isEditing</p>#1#

@if (isLoading)
{
    <p>Loading servers...</p>
}
else if (!string.IsNullOrEmpty(loadError))
{
    <div class="alert alert-danger">
        Error loading servers: @loadError
    </div>
}
else
{
    <button type="button"
            class="btn btn-primary mb-3"
            @onclick="StartCreate">
        Add Server
    </button>

    @if (servers.Count == 0)
    {
        <p>No servers found.</p>
    }
    else
    {
        <table class="table table-striped">
            <thead>
            <tr>
                <th>Hostname</th>
                <th>IP Address</th>
                <th>VCenter IP</th>
                <th>Customer</th>
                <th>Environment</th>
                <th>Role</th>
                <th>Operating System</th>
                <th style="width: 150px;"></th>
            </tr>
            </thead>
            <tbody>
            @foreach (var server in servers)
            {
                <tr>
                    <td>@server.Hostname</td>
                    <td>@server.IpAddress</td>
                    <td>@GetVcenterIp(server.VcenterId)</td>
                    <td>@GetCustomerName(server.CustomerId)</td>
                    <td>@GetEnvironmentName(server.EnvironmentId)</td>
                    <td>@GetRoleName(server.RoleId)</td>
                    <td>@server.OsName</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-2" @onclick="() => StartEdit(server)">Edit</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => ConfirmDelete(server)">Delete</button>
                    </td>
                </tr>
            }
            </tbody>
        </table>

    }

    @if (isCreating || isEditing)
    {
        <div class="card mt-4">
            <div class="card-header">
                @(isCreating ? "Add Server" : "Edit Server")
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Hostname</label>
                    <InputText class="form-control" @bind-Value="editModel.Hostname" />
                </div>

                <div class="mb-3">
                    <label class="form-label">IP Address</label>
                    <InputText class="form-control" @bind-Value="editModel.IpAddress" />
                </div>
                
                <div class="mb-3">
                    <label class="form-label">VCenter (IP)</label>
                    <select class="form-select" @bind="editModel.VcenterId">
                        <option value="">-- Select VCenter --</option>
                        @foreach (var vcenter in vcenters)
                        {
                            <option value="@vcenter.VcenterId">
                                @vcenter.IpAddress @if (!string.IsNullOrWhiteSpace(vcenter.Name)) { @($" ({vcenter.Name})") }
                            </option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Customer</label>
                    <select class="form-select" @bind="editModel.CustomerId">
                        <option value="">-- Select Customer --</option>
                        @foreach (var customer in customers)
                        {
                            <option value="@customer.CustomerId">@customer.Name</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Environment</label>
                    <select class="form-select" @bind="editModel.EnvironmentId">
                        <option value="">-- Select Environment --</option>
                        @foreach (var env in environments)
                        {
                            <option value="@env.EnvironmentId">@env.Name</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Role</label>
                    <select class="form-select" @bind="editModel.RoleId">
                        <option value="0">-- Select Role --</option>
                        @foreach (var role in roles)
                        {
                            <option value="@role.RoleId">@role.Name</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Operating System</label>
                    <InputText class="form-control" @bind-Value="editModel.OsName" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Operating System Version</label>
                    <InputText class="form-control" @bind-Value="editModel.OsFamily" />
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input"
                           type="checkbox"
                           id="isActiveCheck"
                           @bind="editModel.IsActive" />
                    <label class="form-check-label" for="isActiveCheck">
                        Active
                    </label>
                </div>

                <button type="button"
                        class="btn btn-primary me-2"
                        @onclick="SaveAsync">
                    Save
                </button>
                <button type="button"
                        class="btn btn-secondary"
                        @onclick="CancelEdit">
                    Cancel
                </button>
            </div>
        </div>
    }

    @if (deleteCandidate is not null)
    {
        <div class="alert alert-warning mt-4">
            <p>
                Are you sure you want to delete server
                <strong>@deleteCandidate.Hostname</strong> (Id: @deleteCandidate.ServerId)?
            </p>
            <button type="button"
                    class="btn btn-danger me-2"
                    @onclick="ConfirmDeleteAsync">
                Yes, delete
            </button>
            <button type="button"
                    class="btn btn-secondary"
                    @onclick="CancelDelete">
                Cancel
            </button>
        </div>
    }
}

@code {
    private List<Server> servers = new();
    private List<Vcenter> vcenters = new();
    private bool isLoading = true;
    private string? loadError;

    private bool isCreating;
    private bool isEditing;
    private Server editModel = new();

    private Server? deleteCandidate;
    
    private List<Environment> environments = new();
    private List<Role> roles = new();
    private List<Customer> customers = new();

    private string GetEnvironmentName(int environmentId) =>
        environments.FirstOrDefault(e => e.EnvironmentId == environmentId)?.Name
        ?? environmentId.ToString();

    private string GetRoleName(int roleId) =>
        roles.FirstOrDefault(r => r.RoleId == roleId)?.Name
        ?? roleId.ToString();

    private string GetCustomerName(int? customerId) =>
        customerId is null
            ? string.Empty
            : customers.FirstOrDefault(c => c.CustomerId == customerId)?.Name
              ?? customerId.Value.ToString();

    private string GetVcenterIp(int? vcenterId)
        => vcenterId is int id
            ? vcenters.FirstOrDefault(v => v.VcenterId == id)?.IpAddress ?? string.Empty
            : string.Empty;

    /*protected override async Task OnInitializedAsync()
    {
        await LoadServersAsync();
    }*/
    
    protected override async Task OnInitializedAsync()
    {
        await LoadLookupsAsync();
        await LoadServersAsync();
    }

    private async Task LoadLookupsAsync()
    {
        try
        {
            var client = CreateClient();

            var envResult = await client.GetFromJsonAsync<List<Environment>>("api/environments");
            environments = envResult ?? new List<Environment>();

            var roleResult = await client.GetFromJsonAsync<List<Role>>("api/roles");
            roles = roleResult ?? new List<Role>();

            var customerResult = await client.GetFromJsonAsync<List<Customer>>("api/customers");
            customers = customerResult ?? new List<Customer>();
            
            var vcenterResult = await client.GetFromJsonAsync<List<Vcenter>>("api/vcenters");
            vcenters = vcenterResult ?? new List<Vcenter>();

        }
        catch (Exception ex)
        {
            // Donâ€™t block the whole page, but log the error
            loadError = $"Failed to load lookups: {ex.Message}";
        }
    }
    
    private HttpClient CreateClient() => HttpClientFactory.CreateClient("AtlasApi");

    private async Task LoadServersAsync()
    {
        isLoading = true;
        loadError = null;

        try
        {
            var client = CreateClient();
            var result = await client.GetFromJsonAsync<List<Server>>("api/servers");
            servers = result ?? new List<Server>();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void StartCreate()
    {
        isCreating = true;
        isEditing = false;
        deleteCandidate = null;

        editModel = new Server
        {
            IsActive = true,
            IsVm = true,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };

        StateHasChanged();
    }
    
    // /*
    // -------------------------
    // DELETE HANDLER
    // -------------------------
    private void ConfirmDelete(Server server)
    {
        deleteCandidate = server;
        ShowDeleteConfirm = true;
    }

    private bool ShowDeleteConfirm = false;

    // Call this from your "Yes, delete" button
    private async Task DeleteServerAsync()
    {
        if (deleteCandidate is null)
        {
            ShowDeleteConfirm = false;
            return;
        }

        try
        {
            var client = CreateClient();

            var response = await client.DeleteAsync($"api/servers/{deleteCandidate.ServerId}");
            response.EnsureSuccessStatusCode();

            await LoadServersAsync();
        }
        catch (Exception ex)
        {
            loadError = $"Failed to delete server: {ex.Message}";
        }
        finally
        {
            ShowDeleteConfirm = false;
            deleteCandidate = null;
        }
    }
//*/

    private void StartEdit(Server server)
    {
        isEditing = true;
        isCreating = false;
        deleteCandidate = null;

        editModel = new Server
        {
            ServerId          = server.ServerId,
            Hostname          = server.Hostname,
            Fqdn              = server.Fqdn,
            IpAddress         = server.IpAddress,
            SecondaryIp       = server.SecondaryIp,
            OsName            = server.OsName,
            OsFamily          = server.OsFamily,
            OsMajorVersion    = server.OsMajorVersion,
            IsVm              = server.IsVm,
            SourceType        = server.SourceType,
            VmInstanceUuid    = server.VmInstanceUuid,
            VmBiosUuid        = server.VmBiosUuid,
            IsActive          = server.IsActive,
            LifecycleStatus   = server.LifecycleStatus,
            CreatedAt         = server.CreatedAt,
            UpdatedAt         = server.UpdatedAt,
            CommissionedAt    = server.CommissionedAt,
            DecommissionedAt  = server.DecommissionedAt,
            EnvironmentId     = server.EnvironmentId,
            RoleId            = server.RoleId,
            OwnerId           = server.OwnerId,
            LocationId        = server.LocationId,
            CustomerId        = server.CustomerId,
            VcenterId         = server.VcenterId,
            ProjectId         = server.ProjectId
        };
    }
    
    private async Task SaveAsync()
    {
        try
        {
            // basic guard so we don't send junk
            if (editModel.RoleId == 0)
            {
                loadError = "Please select a role before saving.";
                return;
            }
            
            var client = CreateClient();
            HttpResponseMessage response;

            if (isCreating)
            {
                response = await client.PostAsJsonAsync("api/servers", editModel);
            }
            else if (isEditing)
            {
                response = await client.PutAsJsonAsync($"api/servers/{editModel.ServerId}", editModel);
            }
            else
            {
                return;
            }

            if (!response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                loadError = $"Save failed ({(int)response.StatusCode} {response.StatusCode}): {content}";
                return;
            }

            isCreating = false;
            isEditing = false;
            editModel = new Server();

            await LoadServersAsync();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private void CancelEdit()
    {
        isCreating = false;
        isEditing = false;
        editModel = new Server();
    }

    private async Task ConfirmDeleteAsync()
    {
        if (deleteCandidate is null)
            return;

        try
        {
            var client = CreateClient();
            var response = await client.DeleteAsync($"api/servers/{deleteCandidate.ServerId}");
            response.EnsureSuccessStatusCode();

            deleteCandidate = null;
            await LoadServersAsync();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private void CancelDelete()
    {
        deleteCandidate = null;
    }
}
*@
